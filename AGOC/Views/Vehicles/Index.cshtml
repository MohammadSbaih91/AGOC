@model AGOC.Services.Pagination<AGOC.ViewModels.VehicleViewModel>

@{
    ViewData["Title"] = "المركبات";
}

<div class="container mt-4">
    <h2 class="text-center mb-4">المركبات</h2>

    @await Html.PartialAsync("~/Views/Shared/PartialView/_SearchPartial.cshtml",
            new AGOC.ViewModels.SearchViewModel
    {
        SearchText = ViewData["SearchText"]?.ToString(),
        VehicleTypeId = Convert.ToInt32(ViewData["VehicleTypeId"])
    }
            )


    <div class="d-flex justify-content-start mb-3" style="float:left">
        <a href="@Url.Action("Create")" class="btn btn-primary me-2">
            إضافة
            <svg class="svg-inline--fa fa-plus fa-w-14" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="plus" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M416 208H272V64c0-17.67-14.33-32-32-32h-32c-17.67 0-32 14.33-32 32v144H32c-17.67 0-32 14.33-32 32v32c0 17.67 14.33 32 32 32h144v144c0 17.67 14.33 32 32 32h32c17.67 0 32-14.33 32-32V304h144c17.67 0 32-14.33 32-32v-32c0-17.67-14.33-32-32-32z"></path></svg>
        </a>
        
    </div>

    <table class="table table-striped table-bordered">
        <thead class="thead-dark">
            <tr>
                <th>رقم اللوحة</th>
                <th>نوع السيارة</th>
                <th>الموديل</th>
                <th>نوع المركبة</th>
                <th>اللون</th>
                <th class="text-center">الإجراءات</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var vehicle in Model.Items)
            {
                <tr>
                    <td>@vehicle.LicensePlateNumber</td>
                    <td>@vehicle.Brand</td>
                    <td>@vehicle.Model</td>
                    <td>@vehicle.VehicleTypeText</td>
                    <td>@vehicle.Color</td>
                    <td class="text-center">
                        @* <a href="@Url.Action("Details", new { id = vehicle.Id })" class="btn btn-info btn-sm mr-1">تفاصيل</a> *@
                        <a href="@Url.Action("Edit", new { id = vehicle.Id })" class="btn btn-warning btn-sm mr-1">تعديل</a>
                        <button class="btn btn-danger btn-sm delete-button" data-id="@vehicle.Id">حذف</button>

                    </td>
                </tr>
            }
        </tbody>
    </table>
    @await Html.PartialAsync("~/Views/Shared/PartialView/_Pagination.cshtml", Model)
</div>

<!-- نموذج تأكيد الحذف -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" role="dialog" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header d-flex justify-content-between align-items-center">
                <h5 class="modal-title" id="confirmationModalLabel">تأكيد الحذف</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                هل انت متأكد من الحذف  ؟
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="confirmDeleteButton">نعم</button>
                <button type="button" class="btn btn-secondary close" data-dismiss="modal">لا</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        var deleteVehicleId;

        // Handle click on delete button to open modal
        $('.delete-button').click(function () {
            deleteVehicleId = $(this).data('id');
            $('#deleteConfirmationModal').modal('show');
        });

        $(".close").click(function () {
            $('#deleteConfirmationModal').modal('hide');
        });

        // Handle click on confirm delete button
        $('#confirmDeleteButton').click(function () {
            $.ajax({
                url: '/Vehicles/CheckHandoverAndViolations/' + deleteVehicleId,
                type: 'POST',
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function (response) {
                    if (response.success) {
                        location.reload(); // Refresh page after successful deletion
                    } else if (response.confirmMessage) {
                        // Show a confirmation message if the vehicle has violations
                        if (confirm(response.confirmMessage)) {
                            $.ajax({
                                url: '/Vehicles/DeleteConfirmed/' + deleteVehicleId,
                                type: 'POST',
                                headers: {
                                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                                },
                                success: function () {
                                    location.reload(); // Refresh page after successful deletion
                                },
                                error: function () {
                                    alert('حدث خطأ أثناء محاولة حذف المركبة.');
                                }
                            });
                        }
                    } else {
                        alert(response.errorMessage); // Show error message
                    }
                },
                error: function (xhr, status, error) {
                    alert('حدث خطأ أثناء محاولة حذف المركبة.');
                    $('#deleteConfirmationModal').modal('hide');
                }
            });
        });
    });

</script>



